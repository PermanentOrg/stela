name: Generate Image Tags
on:
  workflow_call:
    inputs:
      main_branch_tag:
        description: 'Tag to use for main branch images (main or live)'
        required: false
        type: string
        default: 'main'
    outputs:
      API_IMAGE_TAG:
        value: ${{ jobs.generate_image_tags.outputs.API_IMAGE_TAG }}
      AM_CLEANUP_IMAGE_TAG:
        value: ${{ jobs.generate_image_tags.outputs.AM_CLEANUP_IMAGE_TAG }}
      RECORD_THUMBNAIL_LAMBDA_IMAGE_TAG:
        value: ${{ jobs.generate_image_tags.outputs.RECORD_THUMBNAIL_LAMBDA_IMAGE_TAG }}
      THUMBNAIL_REFRESH_IMAGE_TAG:
        value: ${{ jobs.generate_image_tags.outputs.THUMBNAIL_REFRESH_IMAGE_TAG }}
      FILE_URL_REFRESH_IMAGE_TAG:
        value: ${{ jobs.generate_image_tags.outputs.FILE_URL_REFRESH_IMAGE_TAG }}
      ACCESS_COPY_LAMBDA_IMAGE_TAG:
        value: ${{ jobs.generate_image_tags.outputs.ACCESS_COPY_LAMBDA_IMAGE_TAG }}
      ACCOUNT_SPACE_UPDATE_IMAGE_TAG:
        value: ${{ jobs.generate_image_tags.outputs.ACCOUNT_SPACE_UPDATE_IMAGE_TAG }}
      TRIGGER_ARCHIVEMATICA_IMAGE_TAG:
        value: ${{ jobs.generate_image_tags.outputs.TRIGGER_ARCHIVEMATICA_IMAGE_TAG }}
      METADATA_ATTACHER_LAMBDA_IMAGE_TAG:
        value: ${{ jobs.generate_image_tags.outputs.METADATA_ATTACHER_LAMBDA_IMAGE_TAG }}
jobs:
  generate_image_tags:
    runs-on: ubuntu-24.04
    outputs:
      API_IMAGE_TAG: ${{ steps.generate_api_image_tag.outputs.API_IMAGE_TAG }}
      AM_CLEANUP_IMAGE_TAG: ${{ steps.generate_am_cleanup_image_tag.outputs.AM_CLEANUP_IMAGE_TAG }}
      RECORD_THUMBNAIL_LAMBDA_IMAGE_TAG: ${{ steps.generate_record_thumbnail_lambda_image_tag.outputs.RECORD_THUMBNAIL_LAMBDA_IMAGE_TAG }}
      THUMBNAIL_REFRESH_IMAGE_TAG: ${{ steps.generate_thumbnail_refresh_image_tag.outputs.THUMBNAIL_REFRESH_IMAGE_TAG }}
      FILE_URL_REFRESH_IMAGE_TAG: ${{ steps.generate_file_url_refresh_image_tag.outputs.FILE_URL_REFRESH_IMAGE_TAG }}
      ACCESS_COPY_LAMBDA_IMAGE_TAG: ${{ steps.generate_access_copy_lambda_image_tag.outputs.ACCESS_COPY_LAMBDA_IMAGE_TAG }}
      ACCOUNT_SPACE_UPDATE_IMAGE_TAG: ${{ steps.generate_account_space_updater_image_tag.outputs.ACCOUNT_SPACE_UPDATE_IMAGE_TAG }}
      TRIGGER_ARCHIVEMATICA_IMAGE_TAG: ${{ steps.generate_trigger_archivematica_image_tag.outputs.TRIGGER_ARCHIVEMATICA_IMAGE_TAG }}
      METADATA_ATTACHER_LAMBDA_IMAGE_TAG: ${{ steps.generate_metadata_attacher_lambda_image_tag.outputs.METADATA_ATTACHER_LAMBDA_IMAGE_TAG }}
    steps:
      - uses: actions/checkout@v6
      - name: Set ECR domain env var
        id: set_ecr_domain
        run: echo "ECR_DOMAIN=364159549467.dkr.ecr.$AWS_REGION.amazonaws.com" >> "$GITHUB_ENV"
        env:
          AWS_REGION: ${{ vars.AWS_DEFAULT_REGION }}
      - name: Set tag suffix env var
        id: set_tag_suffix
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            # For tags/releases, use the target branch
            BRANCH_NAME="${{ github.event.release.target_commitish }}"
          else
            # For branch refs, extract the branch name
            BRANCH_NAME="${GITHUB_REF##*/}"
          fi

          # Set TAG_SUFFIX based on whether we're on main
          if [[ "$BRANCH_NAME" == "main" ]]; then
            echo "TAG_SUFFIX=${{ inputs.main_branch_tag }}" >> "$GITHUB_ENV"
          else
            echo "TAG_SUFFIX=feature" >> "$GITHUB_ENV"
          fi
      - name: Set abbreviated commit hash env var
        id: set_abbreviated_commit_hash
        run: echo "ABBREVIATED_COMMIT_HASH=$(git rev-parse --short $GITHUB_SHA)" >> "$GITHUB_ENV"
      - name: Generate API Image Tag
        id: generate_api_image_tag
        run: echo "API_IMAGE_TAG=$ECR_DOMAIN/stela:api-$TAG_SUFFIX-$ABBREVIATED_COMMIT_HASH" >> "$GITHUB_OUTPUT"
      - name: Generate Archivematica Cleanup Image Tag
        id: generate_am_cleanup_image_tag
        run: echo "AM_CLEANUP_IMAGE_TAG=$ECR_DOMAIN/stela:am_cleanup-$TAG_SUFFIX-$ABBREVIATED_COMMIT_HASH" >> "$GITHUB_OUTPUT"
      - name: Generate Record Thumbnail Image Tag
        id: generate_record_thumbnail_lambda_image_tag
        run: echo "RECORD_THUMBNAIL_LAMBDA_IMAGE_TAG=$ECR_DOMAIN/stela:record_thumbnail-$TAG_SUFFIX-$ABBREVIATED_COMMIT_HASH" >> "$GITHUB_OUTPUT"
      - name: Generate Thumbnail Refresh Image Tag
        id: generate_thumbnail_refresh_image_tag
        run: echo "THUMBNAIL_REFRESH_IMAGE_TAG=$ECR_DOMAIN/stela:thumbnail_refresh-$TAG_SUFFIX-$ABBREVIATED_COMMIT_HASH" >> "$GITHUB_OUTPUT"
      - name: Generate File URL Refresh Image Tag
        id: generate_file_url_refresh_image_tag
        run: echo "FILE_URL_REFRESH_IMAGE_TAG=$ECR_DOMAIN/stela:file_url_refresh-$TAG_SUFFIX-$ABBREVIATED_COMMIT_HASH" >> "$GITHUB_OUTPUT"
      - name: Generate Access Copy Lambda Image Tag
        id: generate_access_copy_lambda_image_tag
        run: echo "ACCESS_COPY_LAMBDA_IMAGE_TAG=$ECR_DOMAIN/stela:access_copy_lambda-$TAG_SUFFIX-$ABBREVIATED_COMMIT_HASH" >> "$GITHUB_OUTPUT"
      - name: Generate Account Space Updater Image Tag
        id: generate_account_space_updater_image_tag
        run: echo "ACCOUNT_SPACE_UPDATE_IMAGE_TAG=$ECR_DOMAIN/stela:account_space_updater-$TAG_SUFFIX-$ABBREVIATED_COMMIT_HASH" >> "$GITHUB_OUTPUT"
      - name: Generate Archivematica Triggerer Image Tag
        id: generate_trigger_archivematica_image_tag
        run: echo "TRIGGER_ARCHIVEMATICA_IMAGE_TAG=$ECR_DOMAIN/stela:trigger_archivematica-$TAG_SUFFIX-$ABBREVIATED_COMMIT_HASH" >> "$GITHUB_OUTPUT"
      - name: Generate Metadata Attacher Lambda Image Tag
        id: generate_metadata_attacher_lambda_image_tag
        run: echo "METADATA_ATTACHER_LAMBDA_IMAGE_TAG=$ECR_DOMAIN/stela:metadata_attacher-$TAG_SUFFIX-$ABBREVIATED_COMMIT_HASH" >> "$GITHUB_OUTPUT"
